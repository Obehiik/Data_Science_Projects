---
title: "Longitudinal Analysis of Serum Cholesterol: Examining the Impact of Sex, BMI, and Smoking on 10-Year Trajectories"
author: "Obehi Winnifred Ikpea"
date: "2024"
format: 
  revealjs:
    theme: night
    slideNumber: true
    transition: slide
    slide_layout: true
    width: 1280
    height: 720
    css: "styless.css"
---

```{r echo=FALSE}
library(labelled)   # labeling data
library(rstatix)    # summary statistics
library(ggpubr)     # convenient summary statistics and plots
library(GGally)     # advanced plot
library(car)        # useful for anova/wald test
library(broom)
library(Epi)        # easy getting CI for model coef/pred
library(lvmisc)
library(lme4)  
library(nlme)# linear mixed-effects models
library(lmerTest)   # test for linear mixed-effects models
library(emmeans)    # marginal means
library(multcomp)   # CI for linear combinations of model coef
library(geepack)    # generalized estimating equations
library(ggeffects)  # marginal effects, adjusted predictions
library(gt)  
library(redres)
library(kableExtra)
# nice tables

library(tidyverse)  # for everything (data manipulation, visualization, coding, and more)
theme_set(theme_minimal() + theme(legend.position = "bottom")) # theme for ggplot
# Set the theme for ggplot
theme_set(theme_minimal() + theme(legend.position = "bottom"))

# Load the data
framingham <- read_csv("framingham (2).csv")

framingham_new <- framingham|>
  mutate(across(dplyr::num_range("chol", 0:10), ~ na_if(.x, -9)))|>na.omit()
framingham_new$sex <- factor(framingham_new$sex, levels = c("1", "2"), labels = c("Male", "Female"))
framingham_longer <- framingham_new |>
  mutate(id = row_number()) |>
  pivot_longer(
    cols = starts_with("chol"), 
    names_to = "levels", 
    values_to = "cholesterol"
  ) |>
  mutate(
    year = as.integer(parse_number(levels)),
    levels = fct_inorder(paste("Chol Year", year))
  )
```

## Introduction

## Project Goal

To investigate the longitudinal changes in serum cholesterol levels over a 10-year period and to identify critical factors, including baseline BMI, smoking habits, and demographic variables (age and sex), that influence these changes.

#### Research Questions

1.  Is there a difference in the trajectory of serum cholesterol levels between sexes over the 10-year follow-up period, after accounting for age and baseline BMI?

2.  Is the trajectory of serum cholesterol levels associated with changes in BMI from baseline to 10 years post-baseline, while adjusting for baseline age and sex?

3.  Is the trajectory of serum cholesterol levels over the 10-year follow-up period associated with the number of cigarettes smoked per day at baseline, after adjusting for age and sex?

## Data Description

-   The dataset is a subset of the Framingham study with 11 columns and 2,634 rows.
-   It includes:
    -   Baseline age of participants (age)
    -   Sex at birth (1 for male, 2 for female)
    -   Baseline and 10-year follow-up BMI (bmi0, bmi10)
    -   Number of cigarettes smoked per day at baseline (cigarettes)
    -   Serum cholesterol levels from baseline through ten years (chol0-chol10)

------------------------------------------------------------------------

## Data Description

```{r echo=FALSE}
head(framingham)
```

## Methods

-   Data Preparation

-   Exploratory Data Analysis

-   Statistical Analysis

## Data Preparation

-   Cholesterol levels of -9 were replaced with NA, and missing values were dropped.
-   Sex was encoded as a factor with labels "Male" and "Female."
-   The new dataset contained 1,727 observations.
-   The data was transformed into a longer format with 10,362 observations and 9 variables, where each row represents repeated measurements for an individual.

## Transformed Dataset

```{r echo=FALSE}
head(framingham_longer)
```

## Exploratory Data Analysis

Exploratory data analysis was conducted to:

-   Characterize changes in serum cholesterol over time and its variation by sex.

-   Identify unusual observations.

-   Explore the correlation of repeated measurements.

This involved creating a summary statistics table, boxplots, correlation plots, spaghetti plots, and plots of means.

------------------------------------------------------------------------

### Summary Statistics of Cholesterol by Year

```{r echo=FALSE}
summary_table <- framingham_longer |>
  group_by(year) |>
  get_summary_stats(cholesterol, show = c("n", "mean", "sd")) |>
  gt() |>
  tab_header(
    title = "Cholesterol Summary Statistics by Year (mg/dL)"
  ) |>
  fmt_number(
    columns = vars(mean, sd),
    decimals = 1
  ) |>
  cols_label(
    year = "Year",
    n = "Count",
    mean = "Mean",
    sd = "SD"
  ) |>
  tab_spanner(
    label = "Cholesterol Statistics",
    columns = vars(mean, sd)
  ) |>
  opt_table_font(
    font = "Georgia"
  ) |>
  opt_align_table_header(
    align = "left"
  ) |>
  opt_table_lines()

summary_table
```

**Key Observations**

-   The mean serum cholesterol level increased, growing 29.5 mg/dL from baseline to 10 years.

-   The patterns of serum cholesterol levels showed alternating periods of decrease and increase, indicating a cyclical variability.

------------------------------------------------------------------------

### Boxplot of Cholesterol Levels over Time by Sex

```{r echo=FALSE}
ggplot(framingham_longer, aes(sex, cholesterol, fill = levels)) +
  geom_boxplot() +
  labs(x = "", y = "Serum Cholesterol, mg/dL", title = "Cholesterol Levels by Sex") +
  scale_fill_manual(values = c("#1f78b4", "#33a02c", "#6a3d9a", "#b2df8a", "#fdbf6f", "#e31a1c"))
```

------------------------------------------------------------------------

### Correlation of responses

```{r echo=FALSE}
ggpairs(framingham_new, mapping=aes(colour = sex), columns=6:11,lower = list(continuous = "smooth"))
```

------------------------------------------------------------------------

### Trajectories Over Time

```{r echo=FALSE}
# Plot mean cholesterol levels by sex and year
pal2use <- c("Male" = "#1f78b4", "Female" = "#e31a1c")  # Example colors
ggplot(framingham_longer |> 
         group_by(sex, year) |>
         summarise(mean = mean(cholesterol), .groups = "drop"),
       aes(x = as.integer(year), y = mean, col = sex, shape = sex)) +
  geom_point() +  # Plot points for mean values
  geom_line() +   # Connect points with lines
  labs(
    x = "Year",  # Correct x-axis label
    y = "Mean Cholesterol (mg/dL)",  # Correct y-axis label
    shape = "Sex",  # Legend label for shape
    col = "Sex"  # Legend label for color
  ) +
  scale_colour_manual(values = pal2use) +  # Apply color palette
  scale_x_continuous(breaks = seq(min(framingham_longer$year), max(framingham_longer$year), by = 2)) + # Set x-axis breaks 
  theme_bw()
```

------------------------------------------------------------------------

### Plot of individual data over time

```{r echo=FALSE}
framingham_longer_30<-framingham_longer|>filter(id<=20)

ggplot(framingham_longer_30, aes(year, cholesterol, col = factor(id))) +
  geom_point() +
  geom_line() +
  facet_wrap(~ id) +
  labs(x = "Age, years", y = "Dental growth, mm", col = "Child id") +
  guides(col = guide_legend(nrow = 3))

```

------------------------------------------------------------------------

### Spaghetti plot

```{r echo=FALSE }
ggplot(framingham_longer, aes(x = year, y = cholesterol, col = factor(id))) +
  geom_line() +
  labs(
    x = "Year",  # X-axis label
    y = "Cholesterol (mg/dL)",  # Y-axis label
    title = "Cholesterol Levels Over Time by Sex"  # Plot title
  ) +
  guides(col = "none") +  # Remove color legend
  scale_x_continuous(breaks = seq(min(framingham_longer$year), max(framingham_longer$year), by = 2)) +  # X-axis breaks
  facet_grid(~ sex) +  # Facet by sex
  theme_bw() +  # Use a minimal theme
  theme(
    plot.title = element_text(hjust = 0.5),  # Center the title
    axis.title.x = element_text(size = 12),  # X-axis label size
    axis.title.y = element_text(size = 12),  # Y-axis label size
    strip.text = element_text(size = 12)  # Facet labels size
  )
```

## Summary of Exploratory Data Findings

-   The cholesterol measurements showed a positive linear correlation between consecutive measurements. An interesting observation is that we know that correlation among repeated measures tend to decrease with increasing time separation, but we

-   The spaghetti plot for male participants showed varied patterns, with one person showing a notable increase in cholesterol levels at year 8 and a decrease at year 10.

-   Both sexes had similar mean cholesterol levels at baseline, with males showing higher levels until year 4. After year 4, females displayed higher mean cholesterol levels.Â 

-   Individual data over time revealed mixed patterns in cholesterol level trajectories, including increasing, constant, and decreasing patterns.

## Statistical Analysis {.center}

------------------------------------------------------------------------

## Research Question 1

-   **Is there a difference in the trajectory of serum cholesterol levels between sexes, after accounting for age and baseline BMI?**

-   **Marginal Mean Model**$E[Cholesterol|X]=\beta_0 + \beta_1female + \beta_2year + \beta_3female*year + \beta_4age + \beta_5bmi0$

-   **Models Considered:**

    -   Random intercept model

    -   Random intercept and slope model (uncorrelated)

    -   Random intercept and slope model (correlated)

        -   Independent variable: sex of participant (Male or Female)

        -   Covariates: Baseline age and bmi

-   **Hypothesis testing:**

    -   $H_{0}: \beta_3=0$ ( No difference in the trajectory of cholesterol levels between sexes over time)

```{r echo=FALSE}
## random intercepts only
mod1 <- lmer(cholesterol~year*sex+age+bmi0+(year|id), data=framingham_longer, REML = FALSE, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) 
```

```{r echo=FALSE}
print(anova(mod1,mod2,mod3))

mod3_reduced<-lme(cholesterol ~ sex+year+age+bmi0, data = framingham_longer, method = "ML",
            random = reStruct( ~ 1 + year | id, pdClass="pdSymm", REML=F)) 

print(anova(mod3_reduced, mod3))

```

------------------------------------------------------------------------

## Research Question 2

-   Is the trajectory of serum cholesterol levels associated with changes in BMI from baseline to 10 years post-baseline, while adjusting for baseline age and sex?

-   **Marginal Mean Model**$E[Cholesterol|X]=\beta_0 + \beta_1bmichange + \beta_2year + \beta_3bmichange*year + \beta_4age + \beta_5female$

-   **Models Considered:** Random intercept and slope model

    -   Independent variable: Change in BMI from baseline to 10 years (bmi10-bmi0)

    -   Covariates: Baseline age , sex

    -   **Random effects:** Individual-level intercepts and slopes

-   **Hypothesis testing:**

    -   $H_{0}: \beta_3=0$ (change in BMI is not associated with cholesterol trajectory)

```{r echo=FALSE}
framingham_longer<-framingham_longer|>mutate(bmi_change=bmi10-bmi0)

```

------------------------------------------------------------------------

## Research Question 3

-   **Is the rate of change in serum cholesterol levels associated with the number of cigarettes smoked per day at baseline, after adjusting for age and sex?**

-   **Marginal Mean Model**$E[Cholesterol|X]=\beta_0 + \beta_1cigarettes + \beta_2year + \beta_3year*cigarettes + \beta_4age + \beta_5 female$

-   **Models Considered:** Random intercept and slope model

    -   Independent variable: Baseline number of cigarettes smoked per day.

    -   Covariates: Baseline age , sex

    -   **Random effects:** Individual-level intercepts and slopes

-   **Hypothesis testing:**

    -   $H_{0}: \beta_3=0$ (baseline cigarettes smoked per day is not associated with the rate of change in cholesterol

```{r echo=FALSE}

```

## Results {.center}

------------------------------------------------------------------------

## Research Question 1

-   Model Comparison:

We compared the Random Intercept, Random Intercept and slope (uncorrelated), and Random Intercept and slope (correlated) linear mixed effects model based on Model Fit statistics like the AIC, BIC, and logLik. From the results, The Random Intercept and slope model (Correlated) was considered.

```{r echo=FALSE}
print(anova(mod1,mod2,mod3))
```
------------------------------------------------------------------------
## Model Summary

```{r echo=FALSE}
mod3 <- lme(cholesterol ~ sex*year+age+bmi0, data = framingham_longer, method = "ML",
            random = reStruct( ~ 1 + year | id, pdClass="pdSymm", REML=F)) 
summary(mod3)

anova(mod3_reduced, mod3)
```

```{r}
vario <- Variogram(mod3, form = ~year | id)
ggplot(vario, aes(dist, variog)) + 
  geom_point() +
  geom_line() +
  labs(x = "Time Difference", y = "Semivariance", title = "Empirical Variogram") + 
  theme_minimal()

mod3_cor <- lme(cholesterol ~ sex*year + age + bmi0, 
                data = framingham_longer, 
                method = "ML",
                random = reStruct(~ 1 + year | id, pdClass="pdSymm", REML=F),
                correlation = corCAR1(form = ~ year | id))

```

```{r}
print(anova(mod3, mod3_cor))
```

```{r echo=FALSE}
summary(mod3_cor)
```

```{r}

plot(Variogram(mod3_cor, form = ~ year | id, resType = "normalized"))
heme_minimal()

```
